<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>中文语音播报 Demo</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    select { margin-top: 10px; }
  </style>
</head>
<body>
  <h2>中文语音播报测试</h2>
  <input type="text" id="textInput" placeholder="请输入要播报的文字" size="40">
  <button onclick="speakInput()">播报</button>

  <div>
    <label for="voiceSelect">选择语音：</label>
    <select id="voiceSelect"></select>
  </div>

  <script>
    let voices = [];
    let isSpeaking = false;
    let queue = [];
    let preferredVoiceName = "Tingting"; // 默认首选语音，可改成 Liang-Liang / Yu-Shu 等

    // 获取首选中文语音
    function getPreferredChineseVoice() {
      // 1. 精确匹配首选
      let voice = voices.find(v => v.name === preferredVoiceName && v.lang === "zh-CN");
      if (voice) return voice;

      // 2. fallback: zh-CN 普通话
      voice = voices.find(v => v.lang === "zh-CN");
      if (voice) return voice;

      // 3. fallback: 其他中文（zh 开头，可能是粤语/台语）
      voice = voices.find(v => v.lang.startsWith("zh"));
      if (voice) return voice;

      // 4. fallback: 随便一个
      return voices[0];
    }

    // 核心播报函数
    function speakText(text) {
      if (!('speechSynthesis' in window)) return;
      const utter = new SpeechSynthesisUtterance(text);

      // 用户选择的 voice
      const voiceSelect = document.getElementById("voiceSelect");
      const selectedName = voiceSelect.value;

      let selectedVoice = voices.find(v => v.name === selectedName);
      if (!selectedVoice) {
        selectedVoice = getPreferredChineseVoice();
      }

      if (selectedVoice) utter.voice = selectedVoice;

      utter.rate = 0.9;   // 语速
      utter.pitch = 1;    // 音调
      utter.volume = 1;   // 音量

      utter.onend = () => { isSpeaking = false; processQueue(); };
      utter.onerror = () => { isSpeaking = false; processQueue(); };

      isSpeaking = true;
      speechSynthesis.speak(utter);
    }

    // 队列控制（防止重叠）
    function processQueue() {
      if (!isSpeaking && queue.length > 0) {
        const next = queue.shift();
        speakText(next);
      }
    }

    function speakInput() {
      const text = document.getElementById("textInput").value.trim();
      if (text) {
        queue.push(text);
        processQueue();
      }
    }

    // 加载语音列表
    function populateVoiceList() {
      voices = speechSynthesis.getVoices();
      const voiceSelect = document.getElementById("voiceSelect");
      voiceSelect.innerHTML = "";

      voices
        .filter(v => v.lang.startsWith("zh")) // 只显示中文语音
        .forEach(v => {
          const option = document.createElement("option");
          option.value = v.name;
          option.textContent = `${v.name} [${v.lang}]`;
          voiceSelect.appendChild(option);
        });

      // 默认选中 preferredVoice
      const preferred = voices.find(v => v.name === preferredVoiceName);
      if (preferred) voiceSelect.value = preferred.name;
    }

    speechSynthesis.onvoiceschanged = populateVoiceList;
    window.onload = populateVoiceList;
  </script>
</body>
</html>
