<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>新闻自动朗读</title>
  <style>
    body { font-family: Arial, sans-serif; }
    #start-tips { background: yellow; padding: 10px; cursor: pointer; }
    #news-container { margin-top: 20px; }
    .news-item { margin-bottom: 10px; padding: 5px; border-bottom: 1px solid #ccc; }
  </style>
</head>
<body>
  <div id="start-tips">点击这里启用自动朗读</div>
  <div id="news-container"></div>

  <script>
    let previousNewsIds = new Set();
    let ttsQueue = [];
    let isSpeaking = false;
    let autoReadEnabled = false;
    let voicesReady = false;
    let preferredVoice = null;
    const preferredVoiceName = "婷婷"; // 想要的语音

    function initVoices() {
      const voices = speechSynthesis.getVoices();
      if (!voices || voices.length === 0) {
        alert("语音列表为空，稍后再试");
        return;
      }
      let allVoices = voices.map(v => v.name + " [" + v.lang + "]").join("\n");
      alert("语音列表：\n" + allVoices);

      preferredVoice = voices.find(v => v.name === preferredVoiceName && v.lang === "zh-CN") ||
                       voices.find(v => v.lang === "zh-CN") ||
                       voices.find(v => v.lang.startsWith("zh")) ||
                       voices[0];

      alert("选中的语音：" + (preferredVoice ? preferredVoice.name + " [" + preferredVoice.lang + "]" : "无"));
      voicesReady = true;
    }

    function speakText(text) {
      if (!('speechSynthesis' in window)) {
        alert("浏览器不支持 speechSynthesis");
        return;
      }
      if (!preferredVoice || !voicesReady) {
        alert("语音未准备好");
        return;
      }
      alert("准备朗读：" + text);
      const utter = new SpeechSynthesisUtterance(text);
      utter.voice = preferredVoice;
      utter.rate = 1;
      utter.pitch = 1;
      utter.onend = () => { isSpeaking = false; processQueue(); alert("朗读结束"); };
      utter.onerror = (e) => { isSpeaking = false; processQueue(); alert("朗读出错：" + JSON.stringify(e)); };
      isSpeaking = true;
      speechSynthesis.speak(utter);
    }

    function enqueueText(text) {
      ttsQueue.push(text);
      processQueue();
    }
    function processQueue() {
      if (isSpeaking || ttsQueue.length === 0) return;
      const text = ttsQueue.shift();
      speakText(text);
    }

    function enableAutoRead() {
      if (!autoReadEnabled) {
        autoReadEnabled = true;
        document.getElementById('start-tips').style.display = 'none';
        alert("已点击，激活 TTS");

        // 先用一个空朗读激活 Safari
        const testUtter = new SpeechSynthesisUtterance('');
        speechSynthesis.speak(testUtter);

        // 延迟一点再获取 voices
        setTimeout(initVoices, 500);

        // 启动新闻轮询
        fetchNews();
        setInterval(fetchNews, 15000);
      }
    }

    async function fetchNews() {
      try {
        // 模拟新闻接口（换成你的 API 地址）
        const response = await fetch("https://api.currentsapi.services/v1/latest-news?language=zh&apiKey=demo");
        const data = await response.json();

        const container = document.getElementById("news-container");

        data.news.forEach(item => {
          if (!previousNewsIds.has(item.id)) {
            previousNewsIds.add(item.id);

            const div = document.createElement("div");
            div.className = "news-item";
            div.textContent = item.title;
            container.prepend(div);

            if (autoReadEnabled) {
              enqueueText(item.title);
            }
          }
        });
      } catch (e) {
        console.error("获取新闻失败:", e);
      }
    }

    document.getElementById('start-tips').addEventListener('click', enableAutoRead);
    document.body.addEventListener('click', enableAutoRead, { once: true });
  </script>
</body>
</html>
